import re
from typing import (
    Dict
)
def latex_to_text(latex_formula : str) -> str:
    """
    Chuy·ªÉn ƒë·ªïi c√¥ng th·ª©c LaTeX sang text th√¥ng th∆∞·ªùng
    H·ªó tr·ª£ ƒë·∫ßy ƒë·ªß c√°c k√Ω hi·ªáu to√°n h·ªçc v√† v·∫≠t l√Ω
    """
    # T·∫°o b·∫£n sao ƒë·ªÉ x·ª≠ l√Ω
    text : str = latex_formula
    
    # Dictionary ch·ª©a c√°c ph√©p chuy·ªÉn ƒë·ªïi
    replacements : Dict[str, str] = {
        # === TO√ÅN H·ªåC C∆† B·∫¢N ===
        # Ph√¢n s·ªë
        r'\\frac\{([^}]+)\}\{([^}]+)\}': r'(\1)/(\2)',
        
        # CƒÉn
        r'\\sqrt\{([^}]+)\}': r'‚àö(\1)',
        r'\\sqrt\[([^\]]+)\]\{([^}]+)\}': r'\1‚àö(\2)',  # CƒÉn b·∫≠c n
        
        # L≈©y th·ª´a v√† ch·ªâ s·ªë
        r'\^(\d)': r'^(\1)',  # S·ªë ƒë∆°n
        r'\^\{([^}]+)\}': r'^(\1)',  # Bi·ªÉu th·ª©c ph·ª©c t·∫°p
        r'_(\d)': r'_\1',  # Ch·ªâ s·ªë d∆∞·ªõi ƒë∆°n
        r'_\{([^}]+)\}': r'_(\1)',  # Ch·ªâ s·ªë d∆∞·ªõi ph·ª©c t·∫°p
        
        # === K√ù HI·ªÜU HY L·∫†P ===
        r'\\alpha': 'Œ±',
        r'\\beta': 'Œ≤',
        r'\\gamma': 'Œ≥',
        r'\\delta': 'Œ¥',
        r'\\epsilon': 'Œµ',
        r'\\varepsilon': 'Œµ',
        r'\\zeta': 'Œ∂',
        r'\\eta': 'Œ∑',
        r'\\theta': 'Œ∏',
        r'\\vartheta': 'œë',
        r'\\iota': 'Œπ',
        r'\\kappa': 'Œ∫',
        r'\\lambda': 'Œª',
        r'\\mu': 'Œº',
        r'\\nu': 'ŒΩ',
        r'\\xi': 'Œæ',
        r'\\pi': 'œÄ',
        r'\\rho': 'œÅ',
        r'\\sigma': 'œÉ',
        r'\\tau': 'œÑ',
        r'\\upsilon': 'œÖ',
        r'\\phi': 'œÜ',
        r'\\varphi': 'œÜ',
        r'\\chi': 'œá',
        r'\\psi': 'œà',
        r'\\omega': 'œâ',
        # Ch·ªØ hoa
        r'\\Gamma': 'Œì',
        r'\\Delta': 'Œî',
        r'\\Theta': 'Œò',
        r'\\Lambda': 'Œõ',
        r'\\Xi': 'Œû',
        r'\\Pi': 'Œ†',
        r'\\Sigma': 'Œ£',
        r'\\Upsilon': 'Œ•',
        r'\\Phi': 'Œ¶',
        r'\\Psi': 'Œ®',
        r'\\Omega': 'Œ©',
        
        # === TO√ÅN T·ª¨ TO√ÅN H·ªåC ===
        r'\\times': '√ó',
        r'\\div': '√∑',
        r'\\pm': '¬±',
        r'\\mp': '‚àì',
        r'\\cdot': '¬∑',
        r'\\bullet': '‚Ä¢',
        r'\\circ': '‚óã',
        r'\\infty': '‚àû',
        r'\\approx': '‚âà',
        r'\\neq': '‚â†',
        r'\\equiv': '‚â°',
        r'\\leq': '‚â§',
        r'\\geq': '‚â•',
        r'\\ll': '‚â™',
        r'\\gg': '‚â´',
        r'\\sim': '‚àº',
        r'\\simeq': '‚âÉ',
        r'\\propto': '‚àù',
        r'\\rightarrow': '‚Üí',
        r'\\leftarrow': '‚Üê',
        r'\\leftrightarrow': '‚Üî',
        r'\\Rightarrow': '‚áí',
        r'\\Leftarrow': '‚áê',
        r'\\Leftrightarrow': '‚áî',
        r'\\uparrow': '‚Üë',
        r'\\downarrow': '‚Üì',
        r'\\updownarrow': '‚Üï',
        
        # === ƒê·∫†O H√ÄM V√Ä VI PH√ÇN ===
        r'\\partial': '‚àÇ',
        r'\\nabla': '‚àá',
        r'\\Delta': 'Œî',
        r'\\prime': '‚Ä≤',
        r'\\dot\{([^}]+)\}': r'\1Ãá',  # ƒê·∫°o h√†m theo th·ªùi gian
        r'\\ddot\{([^}]+)\}': r'\1Ãà',  # ƒê·∫°o h√†m b·∫≠c 2 theo th·ªùi gian
        r'\\frac\{d([^}]+)\}\{d([^}]+)\}': r'd\1/d\2',  # ƒê·∫°o h√†m th∆∞·ªùng
        r'\\frac\{d\^2([^}]+)\}\{d([^}]+)\^2\}': r'd¬≤\1/d\2¬≤',  # ƒê·∫°o h√†m b·∫≠c 2
        r'\\frac\{\\partial([^}]+)\}\{\\partial([^}]+)\}': r'‚àÇ\1/‚àÇ\2',  # ƒê·∫°o h√†m ri√™ng
        
        # === T√çCH PH√ÇN ===
        r'\\int': '‚à´',
        r'\\oint': '‚àÆ',
        r'\\iint': '‚à¨',
        r'\\iiint': '‚à≠',
        
        # === T·ªîNG V√Ä T√çCH ===
        r'\\sum': 'Œ£',
        r'\\prod': 'Œ†',
        r'\\coprod': '‚àê',
        
        # === VECTOR V√Ä TENSOR ===
        r'\\vec\{([^}]+)\}': r'\1‚Éó',  # Vector
        r'\\overrightarrow\{([^}]+)\}': r'\1‚Éó',
        r'\\mathbf\{([^}]+)\}': r'ùêõ(\1)',  # Bold vector
        r'\\boldsymbol\{([^}]+)\}': r'ùú∑(\1)',
        r'\\hat\{([^}]+)\}': r'\1ÃÇ',  # Unit vector
        r'\\tilde\{([^}]+)\}': r'\1ÃÉ',
        r'\\bar\{([^}]+)\}': r'\1ÃÑ',
        r'\\overline\{([^}]+)\}': r'\1ÃÖ',
        r'\\underline\{([^}]+)\}': r'\1Ã≤',
        
        # === K√ù HI·ªÜU V·∫¨T L√ù ƒê·∫∂C BI·ªÜT ===
        r'\\hbar': '‚Ñè',  # h-bar (h·∫±ng s·ªë Planck r√∫t g·ªçn)
        r'\\ell': '‚Ñì',  # l vi·∫øt cong
        r'\\Re': '‚Ñú',  # Ph·∫ßn th·ª±c
        r'\\Im': '‚Ñë',  # Ph·∫ßn ·∫£o
        r'\\aleph': '‚Ñµ',
        r'\\wp': '‚Ñò',
        r'\\emptyset': '‚àÖ',
        r'\\varnothing': '‚àÖ',
        r'\\angle': '‚à†',
        r'\\measuredangle': '‚à°',
        r'\\sphericalangle': '‚à¢',
        r'\\parallel': '‚à•',
        r'\\perp': '‚ä•',
        r'\\bot': '‚ä•',
        
        # === L∆Ø·ª¢NG GI√ÅC ===
        r'\\sin': 'sin',
        r'\\cos': 'cos',
        r'\\tan': 'tan',
        r'\\cot': 'cot',
        r'\\sec': 'sec',
        r'\\csc': 'csc',
        r'\\arcsin': 'arcsin',
        r'\\arccos': 'arccos',
        r'\\arctan': 'arctan',
        r'\\sinh': 'sinh',
        r'\\cosh': 'cosh',
        r'\\tanh': 'tanh',
        
        # === LOGARIT V√Ä M≈® ===
        r'\\log': 'log',
        r'\\ln': 'ln',
        r'\\lg': 'lg',
        r'\\exp': 'exp',
        
        # === GI·ªöI H·∫†N V√Ä C√ÅC H√ÄM ===
        r'\\lim': 'lim',
        r'\\sup': 'sup',
        r'\\inf': 'inf',
        r'\\max': 'max',
        r'\\min': 'min',
        r'\\det': 'det',
        r'\\dim': 'dim',
        r'\\deg': 'deg',
        r'\\ker': 'ker',
        r'\\tr': 'tr',
        
        # === T·∫¨P H·ª¢P ===
        r'\\in': '‚àà',
        r'\\notin': '‚àâ',
        r'\\subset': '‚äÇ',
        r'\\supset': '‚äÉ',
        r'\\subseteq': '‚äÜ',
        r'\\supseteq': '‚äá',
        r'\\cup': '‚à™',
        r'\\cap': '‚à©',
        r'\\setminus': '‚àñ',
        r'\\forall': '‚àÄ',
        r'\\exists': '‚àÉ',
        r'\\nexists': '‚àÑ',
        r'\\therefore': '‚à¥',
        r'\\because': '‚àµ',
        
        # === MA TR·∫¨N V√Ä D·∫§U NGO·∫∂C ===
        r'\\begin\{pmatrix\}': '(',
        r'\\end\{pmatrix\}': ')',
        r'\\begin\{bmatrix\}': '[',
        r'\\end\{bmatrix\}': ']',
        r'\\begin\{vmatrix\}': '|',
        r'\\end\{vmatrix\}': '|',
        r'\\begin\{Vmatrix\}': '‚Äñ',
        r'\\end\{Vmatrix\}': '‚Äñ',
        r'\\left\(': '(',
        r'\\right\)': ')',
        r'\\left\[': '[',
        r'\\right\]': ']',
        r'\\left\{': '{',
        r'\\right\}': '}',
        r'\\left\|': '‚Äñ',
        r'\\right\|': '‚Äñ',
        r'\\langle': '‚ü®',
        r'\\rangle': '‚ü©',
        r'\\{': '{',
        r'\\}': '}',
        
        # === ƒê∆†N V·ªä V·∫¨T L√ù (SI) ===
        r'\\mathrm\{kg\}': 'kg',
        r'\\mathrm\{m\}': 'm',
        r'\\mathrm\{s\}': 's',
        r'\\mathrm\{A\}': 'A',
        r'\\mathrm\{K\}': 'K',
        r'\\mathrm\{mol\}': 'mol',
        r'\\mathrm\{cd\}': 'cd',
        r'\\mathrm\{Hz\}': 'Hz',
        r'\\mathrm\{N\}': 'N',
        r'\\mathrm\{Pa\}': 'Pa',
        r'\\mathrm\{J\}': 'J',
        r'\\mathrm\{W\}': 'W',
        r'\\mathrm\{C\}': 'C',
        r'\\mathrm\{V\}': 'V',
        r'\\mathrm\{F\}': 'F',
        r'\\mathrm\{Œ©\}': 'Œ©',
        r'\\mathrm\{S\}': 'S',
        r'\\mathrm\{Wb\}': 'Wb',
        r'\\mathrm\{T\}': 'T',
        r'\\mathrm\{H\}': 'H',
        r'\\mathrm\{¬∞C\}': '¬∞C',
        r'\\mathrm\{lm\}': 'lm',
        r'\\mathrm\{lx\}': 'lx',
        r'\\mathrm\{Bq\}': 'Bq',
        r'\\mathrm\{Gy\}': 'Gy',
        r'\\mathrm\{Sv\}': 'Sv',
        r'\\mathrm\{eV\}': 'eV',
        
        # === C√ÅC K√ù HI·ªÜU KH√ÅC ===
        r'\\&': '&',
        r'\\%': '%',
        r'\\#': '#',
        r'\\S': '¬ß',
        r'\\dagger': '‚Ä†',
        r'\\ddagger': '‚Ä°',
        r'\\star': '‚òÖ',
        r'\\ast': '*',
        r'\\oplus': '‚äï',
        r'\\ominus': '‚äñ',
        r'\\otimes': '‚äó',
        r'\\oslash': '‚äò',
        r'\\odot': '‚äô',
        r'\\bigcirc': '‚óã',
        r'\\square': '‚ñ°',
        r'\\blacksquare': '‚ñ†',
        r'\\triangle': '‚ñ≥',
        r'\\blacktriangle': '‚ñ≤',
        r'\\nabla': '‚àá',
        r'\\diamondsuit': '‚ô¶',
        r'\\heartsuit': '‚ô•',
        r'\\clubsuit': '‚ô£',
        r'\\spadesuit': '‚ô†',
        
        # === KHO·∫¢NG TR·∫ÆNG V√Ä ƒê·ªäNH D·∫†NG ===
        r'\\,': ' ',
        r'\\:': '  ',
        r'\\;': '   ',
        r'\\!': '',
        r'\\quad': '    ',
        r'\\qquad': '        ',
        r'\\\\': '\n',  # Xu·ªëng d√≤ng
        r'\\text\{([^}]+)\}': r'\1',  # Text th∆∞·ªùng
        r'\\mathrm\{([^}]+)\}': r'\1',  # Roman
        r'\\mathit\{([^}]+)\}': r'\1',  # In nghi√™ng
        r'\\mathbb\{([^}]+)\}': r'ùîπ(\1)',  # Blackboard bold
        r'\\mathcal\{([^}]+)\}': r'ùíû(\1)',  # Calligraphy
        r'\\mathfrak\{([^}]+)\}': r'ùîâ(\1)',  # Fraktur
        
        # === X·ª¨ L√ù B·∫¢NG ===
        r'\\begin\{array\}.*?': '',
        r'\\end\{array\}': '',
        r'&': ' | ',  # Ph√¢n c√°ch c·ªôt
    }
    
    # √Åp d·ª•ng c√°c ph√©p thay th·∫ø
    for pattern, replacement in replacements.items():
        text : str = re.sub(pattern, replacement, text)
    
    # === X·ª¨ L√ù ƒê·∫∂C BI·ªÜT ===
    
    # Chuy·ªÉn ƒë·ªïi ch·ªâ s·ªë tr√™n (superscript)
    superscripts : Dict[str, str] = {
        '0': '‚Å∞', '1': '¬π', '2': '¬≤', '3': '¬≥', '4': '‚Å¥',
        '5': '‚Åµ', '6': '‚Å∂', '7': '‚Å∑', '8': '‚Å∏', '9': '‚Åπ',
        '+': '‚Å∫', '-': '‚Åª', '=': '‚Åº', '(': '‚ÅΩ', ')': '‚Åæ',
        'n': '‚Åø', 'i': '‚Å±', 'x': 'À£', 'y': ' ∏', 'z': '·∂ª',
        'a': '·µÉ', 'b': '·µá', 'c': '·∂ú', 'd': '·µà', 'e': '·µâ',
        'f': '·∂†', 'g': '·µç', 'h': ' ∞', 'j': ' ≤', 'k': '·µè',
        'l': 'À°', 'm': '·µê', 'o': '·µí', 'p': '·µñ', 'r': ' ≥',
        's': 'À¢', 't': '·µó', 'u': '·µò', 'v': '·µõ', 'w': ' ∑'
    }
    
    # Chuy·ªÉn ƒë·ªïi ch·ªâ s·ªë d∆∞·ªõi (subscript)
    subscripts : str = {
        '0': '‚ÇÄ', '1': '‚ÇÅ', '2': '‚ÇÇ', '3': '‚ÇÉ', '4': '‚ÇÑ',
        '5': '‚ÇÖ', '6': '‚ÇÜ', '7': '‚Çá', '8': '‚Çà', '9': '‚Çâ',
        '+': '‚Çä', '-': '‚Çã', '=': '‚Çå', '(': '‚Çç', ')': '‚Çé',
        'a': '‚Çê', 'e': '‚Çë', 'h': '‚Çï', 'i': '·µ¢', 'j': '‚±º',
        'k': '‚Çñ', 'l': '‚Çó', 'm': '‚Çò', 'n': '‚Çô', 'o': '‚Çí',
        'p': '‚Çö', 'r': '·µ£', 's': '‚Çõ', 't': '‚Çú', 'u': '·µ§',
        'v': '·µ•', 'x': '‚Çì'
    }
    
    # X·ª≠ l√Ω l≈©y th·ª´a
    def replace_superscript(match):
        exp : str = match.group(1)
        result : str = ''
        for char in exp:
            result += superscripts.get(char, char)
        if result == exp:  # N·∫øu kh√¥ng chuy·ªÉn ƒë∆∞·ª£c h·∫øt
            return f'^({exp})'
        return result
    
    # X·ª≠ l√Ω ch·ªâ s·ªë d∆∞·ªõi
    def replace_subscript(match):
        sub : str = match.group(1)
        result : str = ''
        for char in sub:
            result += subscripts.get(char, char)
        if result == sub:  # N·∫øu kh√¥ng chuy·ªÉn ƒë∆∞·ª£c h·∫øt
            return f'_({sub})'
        return result
    
    # √Åp d·ª•ng chuy·ªÉn ƒë·ªïi superscript v√† subscript
    text : str = re.sub(r'\^\(([^)]+)\)', lambda m: replace_superscript(m), text)
    text : str = re.sub(r'\^(\w)', lambda m: superscripts.get(m.group(1), f'^{m.group(1)}'), text)
    text : str = re.sub(r'_\(([^)]+)\)', lambda m: replace_subscript(m), text)
    text : str = re.sub(r'_(\w)', lambda m: subscripts.get(m.group(1), f'_{m.group(1)}'), text)
    
    # X√≥a d·∫•u $ v√† c√°c k√Ω t·ª± LaTeX c√≤n l·∫°i
    text : str = text.replace('$', '')
    text : str = re.sub(r'\\[a-zA-Z]+', '', text)  # X√≥a c√°c l·ªánh LaTeX kh√¥ng x·ª≠ l√Ω
    
    # L√†m s·∫°ch kho·∫£ng tr·∫Øng th·ª´a
    text : str = re.sub(r'\s+', ' ', text).strip()
    
    return text

# H√†m ti·ªán √≠ch
def convert(latex_formula : str) -> str:
    """H√†m ƒë∆°n gi·∫£n ƒë·ªÉ chuy·ªÉn ƒë·ªïi nhanh"""
    return latex_to_text(latex_formula)
